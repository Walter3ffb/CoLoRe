\documentclass[a4paper,10pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{fullpage}
\newcommand{\nv}{\hat{\bf n}}

%opening
\title{Fast lognormal realizations for multi-probe experiments}
\author{David Alonso}

\begin{document}

\maketitle

\section{Notation}
$\chi$ is comoving radial density. We use units $c=1$ throughout.

\section{Algorithm}
  \begin{itemize}
    \item Generate a Gaussian realization of the linear density field
      $\delta_G$ and the newtonian potential $\phi$ at $z=0$. For
      this we use FFTW in a box able to hold a sufficiently large
      sphere. In what follows, let $\Delta x$ be the comoving resolution 
      of this Cartesian grid.
    \item Interpolate the Cartesian grid into spherical shells. These
      are generated with a width $\Delta r=f_r\Delta x$ (with $f_r=1$
      by default). The pixels are defined using a CAR scheme
      (equirectangular projection), with constant intervals in $\phi$
      and $\theta$.

      Let $N_\theta$ be the number of divisions used in $\theta$. Firstly,
      we will use $2\times N_\theta$ divisions in $\varphi$. Secondly,
      the largest transverse scale covered by a pixel is given by
      $r_\perp^{\rm max}=\chi\,\pi/N_\theta$, where $\chi$ is the comoving
      distance to the shell. We determine $N_\theta$ as \underline{the smallest power
        of 2 that satisfies} $r_\perp^{\rm max}\leq f_\theta\Delta x$
      (with $f_\theta=1$ by default).
    \item While doing the interpolation we compute the relevant
      quantities at $z=0$ that will be used later. These are:
      \begin{itemize}
        \item The radial velocity $v_r$, proportional to the radial
          gradient of $\phi$. This is always computed, and is needed
          for RSDs.
        \item The second derivatives of $\phi$ in the transverse directions.
          This is only computed if any lensing quantity (galaxy shear or
          convergence maps) are required.
        \item The time derivative of $\phi$, $\dot{\phi}$. This is only
          computed if ISW maps are required.
      \end{itemize}
      All radial and transverse derivatives are estimated by first computing
      the gradient or Hessian in Cartesian coordinates using finite differences
      in the box and then rotating into spherical coordinates.
      
    \item The interpolation is carried out in three steps:
      \begin{itemize}
        \item First, each spherical voxel is sub-divided into 
          $N_r^{\rm sub}\times (N_\theta^{\rm sub})^2$ sub-voxels, where $N_r$ is the
          number of divisions taken in the radial direction and $N_\theta$ is
          the number of divisions in the two transverse directions.
          
        \item Each sub-voxel is then assigned a value of the corresponding field
          ($\delta_G$, $v_r$, $\nabla^2_\perp\phi$ or $\dot{\phi}$) by using
          tri-linear interpolation on the sub-voxel centre. Specifically, let
          $(x,y,z)$ be comoving Cartesian coordinates of the sub-voxel, and let
          $(i,j,k)$ denote the cell in the Cartesian grid such that
          \begin{align}
            x_i\leq x<x_{i+1},\hspace{12pt}x_j\leq y<x_{j+1},\hspace{12pt}
            x_k\leq z<x_{k+1},
          \end{align}
          where $x_i\equiv i\,\Delta x$. Let $f_{i,j,k}$ be the value of the
          corresponding field in the Cartesian grid denoted by $(i,j,k)$, and
          let $h_x=(x-x_i)/\Delta x$ etc.. Then, the field value assigned to the sub-voxel
          is given by:
          \begin{align}
            f(x,y,z)=&
            f_{i,j,k}(1-h_x)(1-h_y)(1-h_z)+
            f_{i,j,k+1}(1-h_x)(1-h_y)h_z+\\
            &f_{i,j+1,k}(1-h_x)h_y(1-h_z)+
            f_{i,j+1,k+1}(1-h_x)h_yh_z+\\
            &f_{i+1,j,k}h_x(1-h_y)(1-h_z)+
            f_{i+1,j,k+1}h_x(1-h_y)h_z+\\
            &f_{i+1,j+1,k}h_xh_y(1-h_z)+
            f_{i+1,j+1,k+1}h_xh_yh_z
          \end{align}
        \item The field value assigned to the voxel is then computed as the average
          of the different sub-voxels.
      \end{itemize}
    \item The different fields are evolved according to their linear perturbation growth
      factors and integrated along the line of sight in the case of lensing and ISW (see 
      details below).
    \item The evolved field values are used to Poisson-sample sources, give them RSDs
      and shapes, produce convergence, ISW and intensity maps.
  \end{itemize}

\section{Relevant equations}
  Given the Cartesian realization of the Gaussian density field $\delta_G$ at $z=0$,
  we compute the Newtonian potential by solving Poisson's equation in Fourier space:
  \begin{equation}
    \phi({\bf k},z=0)=-\frac{3}{2}\Omega_MH_0^2\frac{\delta_G({\bf k},z=0)}{k^2},
  \end{equation}

  The radial velocity field is computed in terms of the gradient of the Newtonian
  potential as
  \begin{equation}
    v_r(z=0)=-\frac{2f_0}{3H_0^2\Omega_M}(\nv\cdot\nabla)\phi(z=0),
  \end{equation}
  where $\nv\equiv(\sin\theta\cos\varphi,\sin\theta\sin\varphi,\cos\theta)$.

  The transverse hessian of the gravitational potential is computed as
  \begin{equation}
    \hat{H}_\perp\phi=\hat{R}(\hat{H}\phi)\hat{R}^T
  \end{equation}
  where $\hat{H}$ is the Cartesian Hessian operator, and $\hat{R}$ is a rotation
  matrix:
  \begin{equation}
    \hat{H}\equiv\left(
    \begin{array}{ccc}
      \partial_x\partial_x & \partial_x\partial_y & \partial_x\partial_z\\
      \partial_x\partial_y & \partial_y\partial_y & \partial_y\partial_z\\
      \partial_x\partial_z & \partial_y\partial_z & \partial_z\partial_z
    \end{array}\right),
    \hspace{6pt}
    \hat{R}\equiv\left(
    \begin{array}{ccc}
      \cos\theta\cos\phi & \cos\theta\sin\phi & -\sin\theta\\
      -\sin\phi & \cos\phi & 0
    \end{array}
    \right).
  \end{equation}

  The evolution equations for the different quantities are:
  \begin{align}
    &\delta_G(z)=D(z)\delta(z=0),\hspace{12pt}
    v_r(z)=\frac{D(z)f(z)H(z)}{f_0H_0}v_r(z=0),\\
    &\phi(z)=(1+z)D(z)\phi(z=0),\hspace{12pt}
    \dot{\phi}(z)=(1+z)D(z)H(z)[f(z)-1]\phi(z=0)
  \end{align}

  Finally, we obtain the shear $(\gamma_1,\gamma_2)$, convergence $\kappa$
  and ISW $\Delta^{\rm ISW}$ fields after integrating along the line
  of sight:
  \begin{align}
    &\left(
    \begin{array}{cc}
      \kappa+\gamma_1 & \gamma_2\\
      \gamma_2 & \kappa-\gamma_1
    \end{array}\right)(\chi)=
    2\int_0^\chi d\chi'\chi'\left(1-\frac{\chi'}{\chi}\right)\hat{H}_\perp\phi(\chi')\\
    &\Delta^{\rm ISW}(\chi)=2\int_0^\chi d\chi'a(\chi')\dot{\phi}(\chi')
  \end{align}    


\section{Sources}
  At each voxel, we compute the physical galaxy density for each galaxy
  type $a$ as
  \begin{equation}
    n_a(\chi,\hat{\bf n})=
    \bar{n}_a(\chi)\,
    \exp\left[D(\chi)b_a(\chi)\left(\delta_G(\chi,\hat{\bf n})-
      D(\chi)b_a(\chi)\sigma_G^2/2\right)\right],
  \end{equation}
  where $\bar{n}_a$ is the mean number density of galaxies, and $\sigma_G^2$
  is the variance of the density field at $z=0$. $\bar{n}$ is related to
  $dn/(d\Omega dz)$ as $dn/(d\Omega dz)=\bar{n}\,\chi^2/H$.

  Then, at each pixel we sample a number of galaxies from a Poisson distribution with mean
  $\lambda\equiv V_{\rm pix}n_a$, where $V_{\rm pix}$ is the comoving volume of each
  spherical voxel. We then place the resulting number of particles inside each voxel at
  random within it. Each galaxy is given a cosmological redshift corresponding $z_c$
  corresponding to its comoving distance by inverting
  \begin{equation}
    \chi=\int_0^{z_c}\frac{dz}{H(z)}.
  \end{equation}

  In addition, each galaxy is given a redshift distortion $\Delta z=v_r$ according to the
  value of the comoving velocity field in their corresponding voxel.

  Each source is also given two ellipticity components based on the value of the local
  shear field:
  \begin{equation}
    \epsilon_1=2\gamma_1,\hspace{12pt}\epsilon_2=2\gamma_2.
  \end{equation}
  It is also possible compute the fully non-linear values of the ellipticities, given
  by
  \begin{equation}
    \epsilon_i=2\frac{1-\kappa}{(1-\kappa)^2+\gamma_1^2+\gamma_2^2}\gamma_i.
  \end{equation}

\section{Intensity mapping}
  The brightness temperature for a line-emitting species $a$ in a voxel $i$ is
  \begin{equation}
    T_a(\nu,\hat{\bf n})=\bar{T}_a(\nu)\left[1+\Delta^a_i(\chi\hat{\bf n})\right].
  \end{equation}
  where the mean brightness temperature is
  \begin{equation}
    \bar{T}_a(z)=\frac{3\hbar A_{21} x_2 c^2}{32\pi G k_B m_a \nu_{21}^2}
    \frac{H_0^2\Omega_{a}(z)(1+z)^2}{H(z)}
  \end{equation}
  and $\Delta^a_i$ is the redshift-space overdensity of the line-emitting species
  smoothed over the voxel. Here $x_2$ is the fraction of atoms in the excited state,
  $\Omega_a$ is the fractional density of the species, $\nu_{21}$ is the rest-frame
  frequency of the transition and $A_{21}$ is the corresponding Einstein coefficient
  for emission.

  The procedure to generate intensity maps is:
  \begin{itemize}
    \item We cycle over each voxel in the spherical shells for which we have stored
      the value of the density and velocity fields.
    \item We compute the overdensity in the voxel using a log-normal model:
      \begin{equation}
        1+\delta^a=
        \exp\left[D(\chi)b_a(\chi)\left(\delta_G(\chi,\hat{\bf n})-
          D(\chi)b_a(\chi)\sigma_G^2/2\right)\right].
      \end{equation}
    \item We sub-sample the voxel in $N_{\rm sub}$ random points. Each point is
      assigned a brightness temperature
      \begin{equation}
        T_{a,{\rm sub}}=\bar{T_a}(\nu)\,(1+\delta^a_i)\frac{v_{\rm vox}}{N_{\rm sub}v_{\rm IMAP}},
      \end{equation}
      where $v_{\rm vox}$ is the comoving volume of the voxel and $v_{\rm IMAP}$ is the
      comoving volume of the intensity mapping pixel. Each point is also assigned a redshift
      displacement given by $v_r$, the value of the lightcone-evolved radial velocity
      field in the voxel.
    \item We compute the frequency channel corresponding to each point from their
      redshift (computed as the sum of its cosmological redshift and the RSD term),
      as well as the pixel index in that frequency channel corresponding to the
      angular coordinates of the point. We then add the brightness temperature of
      this point computed in the previous step to the total brightness temperature
      in the pixel.
    \item Each intensity mapping pixel is finally divided by the total comoving
      volume covered by the pixel.
  \end{itemize}
  
\section{Shear}
  We compute the shear tensor as
  \begin{align}
    &\hat{T}\equiv\left(
    \begin{array}{ccc}
      \phi_{xx}&\phi_{xy}&\phi_{xz}\\
      \phi_{yx}&\phi_{yy}&\phi_{yz}\\
      \phi_{zx}&\phi_{zy}&\phi_{zz}\\
    \end{array}\right),\hspace{12pt} 
    \hat{R}\equiv\left(
    \begin{array}{ccc}
      \sin\theta\,\cos\phi&\sin\theta\,\sin\phi&\cos\theta\\
      \cos\theta\,\cos\phi&\cos\theta\,\sin\phi&-\sin\theta\\
      -\sin\phi           &\cos\phi            &0\\
    \end{array}\right),\\
    &\hat{t}\equiv \hat{R}\cdot\hat{T}\cdot\hat{R}^T,\hspace{12pt}
    \hat{\tau}\equiv\left(
    \begin{array}{cc}
      t_{11}&t_{12}\\
      t_{21}&t_{22}
    \end{array}\right),\\
    &\hat{\Gamma}(\chi,\hat{\bf n})
    \equiv\int_0^\chi d\chi'\,\hat{\tau}(\chi'\hat{\bf n})\,
    \chi'\left(1-\frac{\chi'}{\chi}\right)=
    \int_0^\chi d\chi'\,\hat{\tau}(\chi'\hat{\bf n})\,\chi'-
    \frac{1}{\chi}\int_0^\chi d\chi'\,\hat{\tau}(\chi'\hat{\bf n})\,\chi'^2.\\
    &\hat{\Gamma}(\chi_i)=\hat{I}_{i}-\frac{1}{\chi_{i+1/2}}\hat{J}_{i},\hspace{12pt}
    \hat{I}_{i}=\hat{I}_{i-1}+\hat{\tau}(\chi_i)\frac{\chi_{i+1/2}^2-\chi_{i-1/2}^2}{2},\hspace{12pt}
    \hat{J}_{i}=\hat{J}_{i-1}+\hat{\tau}(\chi_i)\frac{\chi_{i+1/2}^3-\chi_{i-1/2}^3}{3}
  \end{align}

\section{CMB lensing}
  For $\kappa\equiv{\rm Tr}(\hat{\Gamma})/2$ we compute, from the simulation, $\kappa(\chi_{\rm max})$,
  where $\chi_{\rm max}$ is the maximum radial distance that fits in the box. In order to get CMB
  lensing we need $\kappa(\chi_{\rm LSS})=\tilde{\kappa}_{\rm max}+\Delta\kappa$, where
  \begin{align}
    \tilde{\kappa}_{\rm max}\equiv\int_0^{\chi_{\rm max}}   d\chi\delta(\chi)\frac{\chi}{2}\left(1-\frac{\chi}{\chi_{\rm LSS}}\right)\\
    \Delta\kappa\equiv\int_{\chi_{\rm max}}^{\chi_{\rm LSS}}d\chi\delta(\chi)\frac{\chi}{2}\left(1-\frac{\chi}{\chi_{\rm LSS}}\right).
  \end{align}
  The strategy to compute these is:
  \begin{itemize}
    \item We compute $\tilde{\kappa}_{\rm max}$ from $\kappa(\chi_{\rm max})$ using the same
      strategy used for shear, but taking care to divide by $\chi_{\rm LSS}$ instead of $\chi_{\rm max}$.
    \item We compute $\Delta\kappa$ as a Gaussian realization constrained to have the right correlation
      with $\tilde{\kappa}_{\rm max}$. Do do this we start by rewriting the previous equation as
      \begin{align}
        &\tilde{\kappa}_{\rm max}\equiv \int d\chi w_1(\chi)\delta(\chi\hat{\bf n}),\hspace{12pt}
        \Delta \kappa           \equiv \int d\chi w_2(\chi)\delta(\chi\hat{\bf n}),\\
        &w_1(\chi)\equiv\frac{\chi}{2}\left(1-\frac{\chi}{\chi_{\rm LSS}}\right)
        \Theta(\chi,0,\chi_{\rm max}),\hspace{12pt}
        w_2(\chi)\equiv\frac{\chi}{2}\left(1-\frac{\chi}{\chi_{\rm LSS}}\right)
        \Theta(\chi,\chi_{\rm max},\chi_{\rm LSS}).
      \end{align}
      where $\Theta(x,x_0,x_f)$ is a top-hat function.

      The covariance matrix of the two terms is therefore
      \begin{align}
        &\langle|\tilde{\kappa}_{{\rm max},\ell m}|^2\rangle=\frac{2}{\pi}\int_0^\infty dk\,k^2\,P(k)\,w^2_{1,\ell}(k),\hspace{12pt}
        \langle|\Delta\kappa_{\ell m}|^2\rangle=\frac{2}{\pi}\int_0^\infty dk\,k^2\,P(k)\,w^2_{2,\ell}(k)\\
        &\langle{\rm Re}(\tilde{\kappa}_{{\rm max},\ell m}\Delta\kappa_{\ell m})\rangle=
        \frac{2}{\pi}\int_0^\infty dk\,k^2\,P(k)\,w_{1,\ell}(k)\,w_{2,\ell}(k),\hspace{12pt}
        w_{i,\ell}(k)\equiv\int_0^\infty d\chi\,w_i(\chi)\,j_\ell(k\chi)
      \end{align}

      Thus we generate a realization of $\Delta\kappa$ at each multipole order as a Gaussian number
      with distribution $\mathcal{N}(\mu,\sigma)$, where
      \begin{align}
        \mu=\frac{\langle{\rm Re}(\tilde{\kappa}_{{\rm max},\ell m}\Delta\kappa_{\ell m})\rangle}
        {\langle|\tilde{\kappa}_{{\rm max},\ell m}|^2\rangle}\tilde{\kappa}_{{\rm max},\ell m},\hspace{12pt}
        \sigma=\langle|\Delta\kappa_{\ell m}|^2\rangle-\frac{\langle{\rm Re}(\tilde{\kappa}_{{\rm max},\ell m}\Delta\kappa_{\ell m})\rangle^2}{\langle|\tilde{\kappa}_{{\rm max},\ell m}|^2\rangle}
      \end{align}
  \end{itemize}

\end{document}

\section{Full-sky expressions}
The angular power spectrum between two contributions is:
\begin{equation}
 C^{ij}_\ell=4\pi\int_0^\infty \frac{dk}{k}\,\mathcal{P}_\Phi(k)\Delta^i_\ell(k)\Delta^j_\ell(k).
\end{equation}
The expressions for density, RSD, magnification, lensing convergence and CMB lensing are:
\begin{align}
  &\Delta_\ell^D(k)=\int dz p_z(z) b(z) T_\delta(k,z) j_\ell(k\chi(z))\\
  &\Delta_\ell^{RSD}(k)=\int dz \frac{(1+z) p_z(z)}{H(z)}T_\theta(k,z) j_\ell''(k\chi(z))\\
  &\Delta_\ell^M(k)=-\ell(\ell+1)\int \frac{dz}{H(z)} W^M(z) T_{\phi+\psi}(k,z) j_\ell(k\chi(z)), \\ 
  &\Delta_\ell^L(k)=-\frac{\ell(\ell+1)}{2}\int \frac{dz}{H(z)} W^L(z) T_{\phi+\psi}(k,z) j_\ell(k\chi(z)),  \\
  &\Delta_\ell^C(k)=\frac{\ell(\ell+1)}{2}\int_0^{\chi_*}d\chi
  \frac{\chi_*-\chi}{\chi\chi_*} T_{\phi+\psi}(k,z) j_\ell(k\chi),  
\end{align}
where
\begin{align}
 &W^M(z)\equiv\int_z^\infty dz' p_z(z')\frac{2-5s(z')}{2}\frac{\chi(z')-\chi(z)}{\chi(z')}\\
 &W^L(z)\equiv\int_z^\infty dz' p_z(z')\frac{\chi(z')-\chi(z)}{\chi(z')}
\end{align}

\section{Limber approximation}
The Limber approximation is
\begin{equation}
 j_\ell(x)\simeq\sqrt{\frac{\pi}{2\ell+1}}\,\delta\left(\ell+\frac{1}{2}-x\right).
\end{equation}
Thus for each $k$ and $\ell$ we can define a radial distance $\chi_\ell\equiv(\ell+1/2)/k$


\section{Expressions in the Limber approximation}
The expressions above can be written as follows in the Limber approximation. First, the power spectrum
can be rewritten as
\begin{equation}
 C^{ij}_\ell=\frac{2}{2\ell+1}\int_0^\infty dk\,P_\delta\left(k,z=0\right)
 \tilde{\Delta}^i_\ell(k)\tilde{\Delta}^j_\ell(k).
\end{equation}
where
\begin{align}
 &\tilde{\Delta}_\ell^D(k)=p_z(\chi_\ell)\,b(\chi_\ell)\,D(\chi_\ell)\,H(\chi_\ell)\\
 &\tilde{\Delta}_\ell^{RSD}(k)=
 \frac{1+8\ell}{(2\ell+1)^2}\,p_z(\chi_\ell)\,f(\chi_\ell)\,D(\chi_\ell)\,H(\chi_\ell)
 -\frac{4}{2\ell+3}\sqrt{\frac{2\ell+1}{2\ell+3}}p_z(\chi_{\ell+1})\,f(\chi_{\ell+1})\,D(\chi_{\ell+1})\,H(\chi_{\ell+1})
\longrightarrow0\\
 &\tilde{\Delta}^{ISW}_\ell(k)=
 \frac{3\Omega_{M,0}H_0^2}{k^2}H(\chi_\ell)g(\chi_\ell)\left[1-f(\chi_\ell)\right]\\
 &\tilde{\Delta}_\ell^M(k)=3\Omega_{M,0}H_0^2\frac{\ell(\ell+1)}{k^2}\,
 \frac{D(\chi_\ell)}{a(\chi_\ell)\chi_\ell}W^M(\chi_\ell)\longrightarrow
 3\Omega_{M,0}H_0^2\,\frac{\chi_\ell D(\chi_\ell)}{a(\chi_\ell)}W^M(\chi_\ell)\\
 &\tilde{\Delta}_\ell^L(k)=\frac{3}{2}\Omega_{M,0}H_0^2\sqrt{\frac{(\ell+2)!}{(\ell-2)}}\frac{1}{k^2}\,
 \frac{D(\chi_\ell)}{a(\chi_\ell)\chi_\ell}W^M(\chi_\ell)\longrightarrow
 \frac{3}{2}\Omega_{M,0}H_0^2\,\frac{\chi_\ell D(\chi_\ell)}{a(\chi_\ell)}W^M(\chi_\ell)\\
 &\tilde{\Delta}_\ell^C(k)=\frac{3}{2}\Omega_{M,0}H_0^2\frac{\ell(\ell+1)}{k^2}\,
 \frac{D(\chi_\ell)}{a(\chi_\ell)\chi_\ell}\frac{\chi_*-\chi_\ell}{\chi_*}\Theta(\chi_\ell-\chi_*)\longrightarrow
 \frac{3}{2}\Omega_{M,0}H_0^2\,\frac{\chi_\ell D(\chi_\ell)}{a(\chi_\ell)}\frac{\chi_*-\chi_\ell}{\chi_*}\Theta(\chi_\ell-\chi_*)
\end{align}



